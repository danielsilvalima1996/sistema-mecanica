import { __decorate, __metadata } from "tslib";
import { Component, ChangeDetectorRef, OnDestroy, OnInit, ViewChild } from '@angular/core';
import { NgForm } from '@angular/forms';
import { PoDynamicFormBaseComponent } from './po-dynamic-form-base.component';
import { PoDynamicFormLoadService } from './po-dynamic-form-load/po-dynamic-form-load.service';
import { PoDynamicFormValidationService } from './po-dynamic-form-validation/po-dynamic-form-validation.service';
/**
 * @docsExtends PoDynamicFormBaseComponent
 *
 * @example
 *
 * <example name="po-dynamic-form-basic" title="PO Dynamic Form Basic">
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.html"> </file>
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-dynamic-form-register" title="PO Dynamic Form - Register">
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.html"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.ts"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.service.ts"> </file>
 * </example>
 */
let PoDynamicFormComponent = class PoDynamicFormComponent extends PoDynamicFormBaseComponent {
    constructor(changes, loadService, validationService) {
        super();
        this.changes = changes;
        this.loadService = loadService;
        this.validationService = validationService;
    }
    set form(value) {
        // necessario para nao ocorrer o ExpressionChangedAfterItHasBeenCheckedError
        setTimeout(() => {
            this._form = value;
            this.emitForm();
        });
    }
    get form() {
        return this._form || {};
    }
    ngOnDestroy() {
        this.removeListeners();
    }
    ngOnInit() {
        if (this.load) {
            this.loadDataOnInitialize();
        }
    }
    /**
     * Função que atribui foco ao campo desejado.
     *
     * Para utilizá-la é necessário capturar a instância do `dynamic form`, como por exemplo:
     *
     * ``` html
     * <po-dynamic-form #dynamicForm [p-fields]="fields"></po-dynamic-form>
     * ```
     *
     * ``` javascript
     * import { PoDynamicFormComponent, PoDynamicFormField } from '@po-ui/ng-components';
     *
     * ...
     *
     * @ViewChild('dynamicForm', { static: true }) dynamicForm: PoDynamicFormComponent;
     *
     * fields: Array<PoDynamicFormField> = [
     *   { property: 'fieldOne' },
     *   { property: 'fieldTwo' }
     * ];
     *
     * fieldFocus() {
     *   this.dynamicForm.focus('fieldTwo');
     * }
     * ```
     *
     * @param {string} property Nome da propriedade atribuída ao `PoDynamicFormField.property`.
     */
    focus(property) {
        this.fieldsComponent.focus(property);
    }
    validateForm(field) {
        const previousFocusElement = document.activeElement;
        this.disableForm(true);
        const errorOnValidation = () => this.disableForm(false);
        this.sendFormSubscription = this.validationService
            .sendFormChange(this.validate, field, this.value)
            .subscribe(this.applyFormValidation(previousFocusElement), errorOnValidation);
    }
    applyFormUpdatesOnLoad(previousFocusElement) {
        return dynamicFormData => {
            this.updateModelOnLoad(dynamicFormData);
            this.disableForm(false);
            this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    }
    applyFormValidation(previousFocusElement) {
        return dynamicFormData => {
            this.updateModelWithValidation(dynamicFormData);
            this.disableForm(false);
            this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    }
    disableForm(value) {
        this.disabledForm = value;
        this.changes.detectChanges();
    }
    emitForm() {
        if (!this.groupForm && this.formOutput.observers.length) {
            this.formOutput.emit(this.form);
        }
    }
    loadDataOnInitialize() {
        const previousFocusElement = document.activeElement;
        this.disabledForm = true;
        const errorOnLoad = () => (this.disabledForm = false);
        this.onLoadSubscription = this.loadService
            .executeLoad(this.load, this.value)
            .subscribe(this.applyFormUpdatesOnLoad(previousFocusElement), errorOnLoad);
    }
    removeListeners() {
        if (this.onLoadSubscription) {
            this.onLoadSubscription.unsubscribe();
        }
        if (this.sendFormSubscription) {
            this.sendFormSubscription.unsubscribe();
        }
    }
    setFocusOnFieldByProperty(property, previousFocusElement) {
        if (property) {
            // precisa do timeout para que o valor seja atribuido no campo antes de setar o focus,
            // para nao disparar a mudança posteriormente. Situação ocorre quando retornar campo com valor e focus atribuido a ele.
            setTimeout(() => this.focus(property));
        }
        else {
            previousFocusElement['focus']();
        }
    }
    updateModelOnLoad(loadedFormData) {
        Object.assign(this.value, loadedFormData.value);
        this.fields = this.loadService.createAndUpdateFieldsForm(loadedFormData.fields, this.fields);
    }
    updateModelWithValidation(formData) {
        Object.assign(this.value, formData.value);
        this.fieldsComponent.updatePreviousValue();
        this.fields = this.validationService.updateFieldsForm(formData.fields, this.fields);
    }
};
PoDynamicFormComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: PoDynamicFormLoadService },
    { type: PoDynamicFormValidationService }
];
__decorate([
    ViewChild('dynamicForm'),
    __metadata("design:type", NgForm),
    __metadata("design:paramtypes", [NgForm])
], PoDynamicFormComponent.prototype, "form", null);
__decorate([
    ViewChild('fieldsComponent'),
    __metadata("design:type", Object)
], PoDynamicFormComponent.prototype, "fieldsComponent", void 0);
PoDynamicFormComponent = __decorate([
    Component({
        selector: 'po-dynamic-form',
        template: "<ng-container *ngIf=\"groupForm; then reuseFormTemplate; else uniqueFormTemplate\"></ng-container>\n\n<ng-template #reuseFormTemplate>\n  <po-dynamic-form-fields #fieldsComponent [p-auto-focus]=\"autoFocus\" [p-fields]=\"fields\" [p-value]=\"value\">\n  </po-dynamic-form-fields>\n</ng-template>\n\n<ng-template #uniqueFormTemplate>\n  <form #dynamicForm=\"ngForm\">\n    <po-dynamic-form-fields\n      #fieldsComponent\n      [(p-fields)]=\"fields\"\n      [p-auto-focus]=\"autoFocus\"\n      [p-disabled-form]=\"disabledForm\"\n      [p-validate]=\"validate\"\n      [p-value]=\"value\"\n      (p-form-validate)=\"validateForm($event)\"\n    >\n    </po-dynamic-form-fields>\n  </form>\n</ng-template>\n"
    }),
    __metadata("design:paramtypes", [ChangeDetectorRef,
        PoDynamicFormLoadService,
        PoDynamicFormValidationService])
], PoDynamicFormComponent);
export { PoDynamicFormComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwby11aS9uZy1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZHluYW1pYy9wby1keW5hbWljLWZvcm0vcG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJeEMsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHOUUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0scURBQXFELENBQUM7QUFFL0YsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUVBQWlFLENBQUM7QUFFakg7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBTUgsSUFBYSxzQkFBc0IsR0FBbkMsTUFBYSxzQkFBdUIsU0FBUSwwQkFBMEI7SUF1QnBFLFlBQ1UsT0FBMEIsRUFDMUIsV0FBcUMsRUFDckMsaUJBQWlEO1FBRXpELEtBQUssRUFBRSxDQUFDO1FBSkEsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDMUIsZ0JBQVcsR0FBWCxXQUFXLENBQTBCO1FBQ3JDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBZ0M7SUFHM0QsQ0FBQztJQXJCeUIsSUFBSSxJQUFJLENBQUMsS0FBYTtRQUM5Qyw0RUFBNEU7UUFDNUUsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1lBRW5CLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLElBQUk7UUFDTixPQUFPLElBQUksQ0FBQyxLQUFLLElB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QjtJQUE3QixTQUFTLENBQUMsaUJBQWlCLENBQUM7OytEQUF5RjtBQXJCM0csc0JBQXNCO0lBSmxDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxpQkFBaUI7UUFDM0IsNnNCQUErQztLQUNoRCxDQUFDO3FDQXlCbUIsaUJBQWlCO1FBQ2Isd0JBQXdCO1FBQ2xCLDhCQUE4QjtHQTFCaEQsc0JBQXNCLENBd0psQztTQXhKWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIENoYW5nZURldGVjdG9yUmVmLCBPbkRlc3Ryb3ksIE9uSW5pdCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOZ0Zvcm0gfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtQmFzZUNvbXBvbmVudCB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1GaWVsZCB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLWZpZWxkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtTG9hZCB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLWxvYWQvcG8tZHluYW1pYy1mb3JtLWxvYWQuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1Mb2FkU2VydmljZSB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLWxvYWQvcG8tZHluYW1pYy1mb3JtLWxvYWQuc2VydmljZSc7XG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtVmFsaWRhdGlvbiB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uU2VydmljZSB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24uc2VydmljZSc7XG5cbi8qKlxuICogQGRvY3NFeHRlbmRzIFBvRHluYW1pY0Zvcm1CYXNlQ29tcG9uZW50XG4gKlxuICogQGV4YW1wbGVcbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tZHluYW1pYy1mb3JtLWJhc2ljXCIgdGl0bGU9XCJQTyBEeW5hbWljIEZvcm0gQmFzaWNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLWJhc2ljLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLWR5bmFtaWMtZm9ybS1yZWdpc3RlclwiIHRpdGxlPVwiUE8gRHluYW1pYyBGb3JtIC0gUmVnaXN0ZXJcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci5zZXJ2aWNlLnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqL1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdwby1keW5hbWljLWZvcm0nLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb0R5bmFtaWNGb3JtQ29tcG9uZW50IGV4dGVuZHMgUG9EeW5hbWljRm9ybUJhc2VDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgX2Zvcm06IE5nRm9ybTtcblxuICBkaXNhYmxlZEZvcm06IGJvb2xlYW47XG5cbiAgcHJpdmF0ZSBvbkxvYWRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBzZW5kRm9ybVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIEBWaWV3Q2hpbGQoJ2R5bmFtaWNGb3JtJykgc2V0IGZvcm0odmFsdWU6IE5nRm9ybSkge1xuICAgIC8vIG5lY2Vzc2FyaW8gcGFyYSBuYW8gb2NvcnJlciBvIEV4cHJlc3Npb25DaGFuZ2VkQWZ0ZXJJdEhhc0JlZW5DaGVja2VkRXJyb3JcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuX2Zvcm0gPSB2YWx1ZTtcblxuICAgICAgdGhpcy5lbWl0Rm9ybSgpO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0IGZvcm0oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Zvcm0gfHwgPGFueT57fTtcbiAgfVxuXG4gIEBWaWV3Q2hpbGQoJ2ZpZWxkc0NvbXBvbmVudCcpIGZpZWxkc0NvbXBvbmVudDogeyBmb2N1czogKHByb3BlcnR5OiBzdHJpbmcpID0+IHZvaWQ7IHVwZGF0ZVByZXZpb3VzVmFsdWU6ICgpID0+IHZvaWQgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNoYW5nZXM6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgbG9hZFNlcnZpY2U6IFBvRHluYW1pY0Zvcm1Mb2FkU2VydmljZSxcbiAgICBwcml2YXRlIHZhbGlkYXRpb25TZXJ2aWNlOiBQb0R5bmFtaWNGb3JtVmFsaWRhdGlvblNlcnZpY2VcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzKCk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICBpZiAodGhpcy5sb2FkKSB7XG4gICAgICB0aGlzLmxvYWREYXRhT25Jbml0aWFsaXplKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEZ1bsOnw6NvIHF1ZSBhdHJpYnVpIGZvY28gYW8gY2FtcG8gZGVzZWphZG8uXG4gICAqXG4gICAqIFBhcmEgdXRpbGl6w6EtbGEgw6kgbmVjZXNzw6FyaW8gY2FwdHVyYXIgYSBpbnN0w6JuY2lhIGRvIGBkeW5hbWljIGZvcm1gLCBjb21vIHBvciBleGVtcGxvOlxuICAgKlxuICAgKiBgYGAgaHRtbFxuICAgKiA8cG8tZHluYW1pYy1mb3JtICNkeW5hbWljRm9ybSBbcC1maWVsZHNdPVwiZmllbGRzXCI+PC9wby1keW5hbWljLWZvcm0+XG4gICAqIGBgYFxuICAgKlxuICAgKiBgYGAgamF2YXNjcmlwdFxuICAgKiBpbXBvcnQgeyBQb0R5bmFtaWNGb3JtQ29tcG9uZW50LCBQb0R5bmFtaWNGb3JtRmllbGQgfSBmcm9tICdAcG8tdWkvbmctY29tcG9uZW50cyc7XG4gICAqXG4gICAqIC4uLlxuICAgKlxuICAgKiBAVmlld0NoaWxkKCdkeW5hbWljRm9ybScsIHsgc3RhdGljOiB0cnVlIH0pIGR5bmFtaWNGb3JtOiBQb0R5bmFtaWNGb3JtQ29tcG9uZW50O1xuICAgKlxuICAgKiBmaWVsZHM6IEFycmF5PFBvRHluYW1pY0Zvcm1GaWVsZD4gPSBbXG4gICAqICAgeyBwcm9wZXJ0eTogJ2ZpZWxkT25lJyB9LFxuICAgKiAgIHsgcHJvcGVydHk6ICdmaWVsZFR3bycgfVxuICAgKiBdO1xuICAgKlxuICAgKiBmaWVsZEZvY3VzKCkge1xuICAgKiAgIHRoaXMuZHluYW1pY0Zvcm0uZm9jdXMoJ2ZpZWxkVHdvJyk7XG4gICAqIH1cbiAgICogYGBgXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBOb21lIGRhIHByb3ByaWVkYWRlIGF0cmlidcOtZGEgYW8gYFBvRHluYW1pY0Zvcm1GaWVsZC5wcm9wZXJ0eWAuXG4gICAqL1xuICBmb2N1cyhwcm9wZXJ0eTogc3RyaW5nKSB7XG4gICAgdGhpcy5maWVsZHNDb21wb25lbnQuZm9jdXMocHJvcGVydHkpO1xuICB9XG5cbiAgdmFsaWRhdGVGb3JtKGZpZWxkOiBQb0R5bmFtaWNGb3JtRmllbGQpIHtcbiAgICBjb25zdCBwcmV2aW91c0ZvY3VzRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XG5cbiAgICB0aGlzLmRpc2FibGVGb3JtKHRydWUpO1xuICAgIGNvbnN0IGVycm9yT25WYWxpZGF0aW9uID0gKCkgPT4gdGhpcy5kaXNhYmxlRm9ybShmYWxzZSk7XG5cbiAgICB0aGlzLnNlbmRGb3JtU3Vic2NyaXB0aW9uID0gdGhpcy52YWxpZGF0aW9uU2VydmljZVxuICAgICAgLnNlbmRGb3JtQ2hhbmdlKHRoaXMudmFsaWRhdGUsIGZpZWxkLCB0aGlzLnZhbHVlKVxuICAgICAgLnN1YnNjcmliZSh0aGlzLmFwcGx5Rm9ybVZhbGlkYXRpb24ocHJldmlvdXNGb2N1c0VsZW1lbnQpLCBlcnJvck9uVmFsaWRhdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGFwcGx5Rm9ybVVwZGF0ZXNPbkxvYWQocHJldmlvdXNGb2N1c0VsZW1lbnQ6IEVsZW1lbnQpOiAoZHluYW1pY0Zvcm1EYXRhOiBQb0R5bmFtaWNGb3JtTG9hZCkgPT4gdm9pZCB7XG4gICAgcmV0dXJuIGR5bmFtaWNGb3JtRGF0YSA9PiB7XG4gICAgICB0aGlzLnVwZGF0ZU1vZGVsT25Mb2FkKGR5bmFtaWNGb3JtRGF0YSk7XG4gICAgICB0aGlzLmRpc2FibGVGb3JtKGZhbHNlKTtcbiAgICAgIHRoaXMuc2V0Rm9jdXNPbkZpZWxkQnlQcm9wZXJ0eShkeW5hbWljRm9ybURhdGEuZm9jdXMsIHByZXZpb3VzRm9jdXNFbGVtZW50KTtcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBseUZvcm1WYWxpZGF0aW9uKHByZXZpb3VzRm9jdXNFbGVtZW50OiBFbGVtZW50KTogKGR5bmFtaWNGb3JtRGF0YTogUG9EeW5hbWljRm9ybVZhbGlkYXRpb24pID0+IHZvaWQge1xuICAgIHJldHVybiBkeW5hbWljRm9ybURhdGEgPT4ge1xuICAgICAgdGhpcy51cGRhdGVNb2RlbFdpdGhWYWxpZGF0aW9uKGR5bmFtaWNGb3JtRGF0YSk7XG4gICAgICB0aGlzLmRpc2FibGVGb3JtKGZhbHNlKTtcbiAgICAgIHRoaXMuc2V0Rm9jdXNPbkZpZWxkQnlQcm9wZXJ0eShkeW5hbWljRm9ybURhdGEuZm9jdXMsIHByZXZpb3VzRm9jdXNFbGVtZW50KTtcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNhYmxlRm9ybSh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuZGlzYWJsZWRGb3JtID0gdmFsdWU7XG4gICAgdGhpcy5jaGFuZ2VzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgZW1pdEZvcm0oKSB7XG4gICAgaWYgKCF0aGlzLmdyb3VwRm9ybSAmJiB0aGlzLmZvcm1PdXRwdXQub2JzZXJ2ZXJzLmxlbmd0aCkge1xuICAgICAgdGhpcy5mb3JtT3V0cHV0LmVtaXQodGhpcy5mb3JtKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGxvYWREYXRhT25Jbml0aWFsaXplKCkge1xuICAgIGNvbnN0IHByZXZpb3VzRm9jdXNFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcblxuICAgIHRoaXMuZGlzYWJsZWRGb3JtID0gdHJ1ZTtcbiAgICBjb25zdCBlcnJvck9uTG9hZCA9ICgpID0+ICh0aGlzLmRpc2FibGVkRm9ybSA9IGZhbHNlKTtcblxuICAgIHRoaXMub25Mb2FkU3Vic2NyaXB0aW9uID0gdGhpcy5sb2FkU2VydmljZVxuICAgICAgLmV4ZWN1dGVMb2FkKHRoaXMubG9hZCwgdGhpcy52YWx1ZSlcbiAgICAgIC5zdWJzY3JpYmUodGhpcy5hcHBseUZvcm1VcGRhdGVzT25Mb2FkKHByZXZpb3VzRm9jdXNFbGVtZW50KSwgZXJyb3JPbkxvYWQpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVMaXN0ZW5lcnMoKSB7XG4gICAgaWYgKHRoaXMub25Mb2FkU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLm9uTG9hZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNlbmRGb3JtU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnNlbmRGb3JtU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRGb2N1c09uRmllbGRCeVByb3BlcnR5KHByb3BlcnR5OiBzdHJpbmcsIHByZXZpb3VzRm9jdXNFbGVtZW50OiBFbGVtZW50KSB7XG4gICAgaWYgKHByb3BlcnR5KSB7XG4gICAgICAvLyBwcmVjaXNhIGRvIHRpbWVvdXQgcGFyYSBxdWUgbyB2YWxvciBzZWphIGF0cmlidWlkbyBubyBjYW1wbyBhbnRlcyBkZSBzZXRhciBvIGZvY3VzLFxuICAgICAgLy8gcGFyYSBuYW8gZGlzcGFyYXIgYSBtdWRhbsOnYSBwb3N0ZXJpb3JtZW50ZS4gU2l0dWHDp8OjbyBvY29ycmUgcXVhbmRvIHJldG9ybmFyIGNhbXBvIGNvbSB2YWxvciBlIGZvY3VzIGF0cmlidWlkbyBhIGVsZS5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5mb2N1cyhwcm9wZXJ0eSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcmV2aW91c0ZvY3VzRWxlbWVudFsnZm9jdXMnXSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlTW9kZWxPbkxvYWQobG9hZGVkRm9ybURhdGE6IFBvRHluYW1pY0Zvcm1Mb2FkKSB7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLnZhbHVlLCBsb2FkZWRGb3JtRGF0YS52YWx1ZSk7XG4gICAgdGhpcy5maWVsZHMgPSB0aGlzLmxvYWRTZXJ2aWNlLmNyZWF0ZUFuZFVwZGF0ZUZpZWxkc0Zvcm0obG9hZGVkRm9ybURhdGEuZmllbGRzLCB0aGlzLmZpZWxkcyk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZU1vZGVsV2l0aFZhbGlkYXRpb24oZm9ybURhdGE6IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uKSB7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLnZhbHVlLCBmb3JtRGF0YS52YWx1ZSk7XG4gICAgdGhpcy5maWVsZHNDb21wb25lbnQudXBkYXRlUHJldmlvdXNWYWx1ZSgpO1xuICAgIHRoaXMuZmllbGRzID0gdGhpcy52YWxpZGF0aW9uU2VydmljZS51cGRhdGVGaWVsZHNGb3JtKGZvcm1EYXRhLmZpZWxkcywgdGhpcy5maWVsZHMpO1xuICB9XG59XG4iXX0=
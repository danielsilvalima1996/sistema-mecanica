import { __decorate, __extends, __metadata } from "tslib";
import { ChangeDetectorRef, Component, ElementRef, Renderer2, ViewChild, ViewContainerRef } from '@angular/core';
import { Router } from '@angular/router';
import { callFunction, getParentRef, isExternalLink, isTypeof, openExternalLink } from '../../utils/util';
import { PoControlPositionService } from '../../services/po-control-position/po-control-position.service';
import { PoPopupBaseComponent } from './po-popup-base.component';
/**
 *
 * @docsExtends PoPopupBaseComponent
 *
 * @example
 *
 * <example name="po-popup-basic" title="PO Popup - Basic">
 *   <file name="sample-po-popup-basic/sample-po-popup-basic.component.html"> </file>
 *   <file name="sample-po-popup-basic/sample-po-popup-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-popup-labs" title="PO Popup - Labs">
 *   <file name="sample-po-popup-labs/sample-po-popup-labs.component.html"> </file>
 *   <file name="sample-po-popup-labs/sample-po-popup-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-popup-email" title="PO Popup Email">
 *   <file name="sample-po-popup-email/sample-po-popup-email.component.html"> </file>
 *   <file name="sample-po-popup-email/sample-po-popup-email.component.ts"> </file>
 * </example>
 *
 */
var PoPopupComponent = /** @class */ (function (_super) {
    __extends(PoPopupComponent, _super);
    function PoPopupComponent(viewContainerRef, renderer, router, poControlPosition, changeDetector) {
        var _this = _super.call(this) || this;
        _this.renderer = renderer;
        _this.router = router;
        _this.poControlPosition = poControlPosition;
        _this.changeDetector = changeDetector;
        _this.onScroll = function () {
            if (_this.showPopup) {
                _this.close();
            }
        };
        _this.parentRef = getParentRef(viewContainerRef);
        return _this;
    }
    /**
     * Fecha o componente *popup*.
     *
     * > Por padrão, este comportamento é acionado somente ao clicar fora do componente ou em determinada ação / url.
     */
    PoPopupComponent.prototype.close = function () {
        this.removeListeners();
        this.showPopup = false;
    };
    PoPopupComponent.prototype.onActionClick = function (popupAction) {
        var actionNoDisabled = popupAction && !this.returnBooleanValue(popupAction, 'disabled');
        if (popupAction && popupAction.action && actionNoDisabled) {
            this.close();
            return callFunction(popupAction.action, this.parentRef, this.param || popupAction);
        }
        if (popupAction && popupAction.url && actionNoDisabled) {
            this.close();
            return this.openUrl(popupAction.url);
        }
    };
    /**
     * Abre o componente *popup*.
     *
     * > É possível informar um parâmetro que será utilizado na execução da ação do item e na função de desabilitar.
     */
    PoPopupComponent.prototype.open = function (param) {
        this.oldTarget = this.target;
        this.param = param;
        this.showPopup = true;
        this.changeDetector.detectChanges();
        this.validateInitialContent();
    };
    PoPopupComponent.prototype.returnBooleanValue = function (popupAction, property) {
        return isTypeof(popupAction[property], 'function')
            ? popupAction[property](this.param || popupAction)
            : popupAction[property];
    };
    /**
     * Responsável por abrir e fechar o *popup*.
     *
     * Quando disparado abrirá o *popup* e caso o mesmo já estiver aberto e possuir o mesmo `target` irá fecha-lo.
     *
     * É possível informar um parâmetro que será utilizado na execução da ação do item e na função de desabilitar.
     */
    PoPopupComponent.prototype.toggle = function (param) {
        this.showPopup && this.oldTarget === this.target ? this.close() : this.open(param);
    };
    PoPopupComponent.prototype.clickedOutDisabledItem = function (event) {
        var containsItemDisabled = this.elementContains(event.target, 'po-popup-item-disabled') ||
            this.elementContains(event.target.parentElement, 'po-popup-item-disabled');
        return !containsItemDisabled;
    };
    PoPopupComponent.prototype.clickedOutHeaderTemplate = function (event) {
        var popupHeaderTemplate = this.popupRef && this.popupRef.nativeElement.querySelector('[p-popup-header-template]');
        return !(popupHeaderTemplate && popupHeaderTemplate.contains(event.target));
    };
    PoPopupComponent.prototype.clickedOutTarget = function (event) {
        return this.target && !this.target.contains(event.target);
    };
    PoPopupComponent.prototype.closePopupOnClickout = function (event) {
        if (this.clickedOutTarget(event) && this.clickedOutDisabledItem(event) && this.clickedOutHeaderTemplate(event)) {
            this.close();
        }
    };
    PoPopupComponent.prototype.elementContains = function (element, className) {
        return element && element.classList.contains(className);
    };
    PoPopupComponent.prototype.hasContentToShow = function () {
        return !!(this.popupRef.nativeElement && this.popupRef.nativeElement.clientHeight);
    };
    PoPopupComponent.prototype.initializeListeners = function () {
        var _this = this;
        this.resizeListener = this.renderer.listen('window', 'resize', function () {
            _this.close();
        });
        this.clickoutListener = this.renderer.listen('document', 'click', function (event) {
            _this.closePopupOnClickout(event);
        });
        window.addEventListener('scroll', this.onScroll, true);
    };
    PoPopupComponent.prototype.openUrl = function (url) {
        if (isExternalLink(url)) {
            return openExternalLink(url);
        }
        if (url) {
            return this.router.navigate([url]);
        }
    };
    PoPopupComponent.prototype.removeListeners = function () {
        if (this.clickoutListener) {
            this.clickoutListener();
        }
        if (this.resizeListener) {
            this.resizeListener();
        }
        window.removeEventListener('scroll', this.onScroll, true);
    };
    PoPopupComponent.prototype.setPosition = function () {
        this.poControlPosition.setElements(this.popupRef.nativeElement, 8, this.target, this.customPositions, false, this.isCornerAlign);
        this.poControlPosition.adjustPosition(this.position);
        this.arrowDirection = this.poControlPosition.getArrowDirection();
    };
    PoPopupComponent.prototype.validateInitialContent = function () {
        if (this.hasContentToShow()) {
            this.setPosition();
            this.initializeListeners();
        }
        else {
            this.close();
        }
    };
    PoPopupComponent.ctorParameters = function () { return [
        { type: ViewContainerRef },
        { type: Renderer2 },
        { type: Router },
        { type: PoControlPositionService },
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        ViewChild('popupRef', { read: ElementRef }),
        __metadata("design:type", ElementRef)
    ], PoPopupComponent.prototype, "popupRef", void 0);
    PoPopupComponent = __decorate([
        Component({
            selector: 'po-popup',
            template: "<div #popupRef class=\"po-popup\" *ngIf=\"showPopup\">\n  <div *ngIf=\"!hideArrow\" class=\"po-popup-arrow po-arrow-{{ arrowDirection }}\"></div>\n\n  <ng-content select=\"[p-popup-header-template]\"></ng-content>\n\n  <ng-container *ngFor=\"let action of actions; let actionIndex = index\">\n    <div\n      *ngIf=\"action.visible !== false\"\n      [class.po-popup-item-default]=\"action.type !== 'danger'\"\n      [class.po-popup-item-danger]=\"action.type === 'danger'\"\n      [class.po-popup-item-disabled]=\"returnBooleanValue(action, 'disabled')\"\n      [class.po-popup-item-separator]=\"action.separator && actionIndex !== 0\"\n      [class.po-popup-item-selected]=\"action.selected\"\n      (click)=\"onActionClick(action)\"\n    >\n      <span *ngIf=\"action.icon\" class=\"po-icon {{ action.icon }} po-popup-icon-item\"></span>\n      {{ action.label }}\n    </div>\n  </ng-container>\n</div>\n",
            providers: [PoControlPositionService]
        }),
        __metadata("design:paramtypes", [ViewContainerRef,
            Renderer2,
            Router,
            PoControlPositionService,
            ChangeDetectorRef])
    ], PoPopupComponent);
    return PoPopupComponent;
}(PoPopupBaseComponent));
export { PoPopupComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcG9wdXAuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvLXVpL25nLWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby1wb3B1cC9wby1wb3B1cC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakgsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXpDLE9BQU8sRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUMxRyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxnRUFBZ0UsQ0FBQztBQUcxRyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUVqRTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBcUJHO0FBTUg7SUFBc0Msb0NBQW9CO0lBR3hELDBCQUNFLGdCQUFrQyxFQUMxQixRQUFtQixFQUNuQixNQUFjLEVBQ2QsaUJBQTJDLEVBQzVDLGNBQWlDO1FBTDFDLFlBT0UsaUJBQU8sU0FFUjtRQVBTLGNBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsWUFBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLHVCQUFpQixHQUFqQixpQkFBaUIsQ0FBMEI7UUFDNUMsb0JBQWMsR0FBZCxjQUFjLENBQW1CO1FBd0dsQyxjQUFRLEdBQUc7WUFDakIsSUFBSSxLQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixLQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDZDtRQUNILENBQUMsQ0FBQztRQXpHQSxLQUFJLENBQUMsU0FBUyxHQUFHLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOztJQUNsRCxDQUFDO0lBRUQ7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O2dCQUM1QixpQkFBaUI7O0lBUEc7UUFBNUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQztrQ0FBVyxVQUFVO3NEQUFDO0lBRHZELGdCQUFnQjtRQUw1QixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsVUFBVTtZQUNwQix1NUJBQXdDO1lBQ3hDLFNBQVMsRUFBRSxDQUFDLHdCQUF3QixDQUFDO1NBQ3RDLENBQUM7eUNBS29CLGdCQUFnQjtZQUNoQixTQUFTO1lBQ1gsTUFBTTtZQUNLLHdCQUF3QjtZQUM1QixpQkFBaUI7T0FSL0IsZ0JBQWdCLENBaUs1QjtJQUFELHVCQUFDO0NBQUEsQUFqS0QsQ0FBc0Msb0JBQW9CLEdBaUt6RDtTQWpLWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBSZW5kZXJlcjIsIFZpZXdDaGlsZCwgVmlld0NvbnRhaW5lclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgY2FsbEZ1bmN0aW9uLCBnZXRQYXJlbnRSZWYsIGlzRXh0ZXJuYWxMaW5rLCBpc1R5cGVvZiwgb3BlbkV4dGVybmFsTGluayB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWwnO1xuaW1wb3J0IHsgUG9Db250cm9sUG9zaXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tY29udHJvbC1wb3NpdGlvbi9wby1jb250cm9sLXBvc2l0aW9uLnNlcnZpY2UnO1xuXG5pbXBvcnQgeyBQb1BvcHVwQWN0aW9uIH0gZnJvbSAnLi9wby1wb3B1cC1hY3Rpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvUG9wdXBCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1wb3B1cC1iYXNlLmNvbXBvbmVudCc7XG5cbi8qKlxuICpcbiAqIEBkb2NzRXh0ZW5kcyBQb1BvcHVwQmFzZUNvbXBvbmVudFxuICpcbiAqIEBleGFtcGxlXG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLXBvcHVwLWJhc2ljXCIgdGl0bGU9XCJQTyBQb3B1cCAtIEJhc2ljXCI+XG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tcG9wdXAtYmFzaWMvc2FtcGxlLXBvLXBvcHVwLWJhc2ljLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1wb3B1cC1iYXNpYy9zYW1wbGUtcG8tcG9wdXAtYmFzaWMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tcG9wdXAtbGFic1wiIHRpdGxlPVwiUE8gUG9wdXAgLSBMYWJzXCI+XG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tcG9wdXAtbGFicy9zYW1wbGUtcG8tcG9wdXAtbGFicy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tcG9wdXAtbGFicy9zYW1wbGUtcG8tcG9wdXAtbGFicy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1wb3B1cC1lbWFpbFwiIHRpdGxlPVwiUE8gUG9wdXAgRW1haWxcIj5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1wb3B1cC1lbWFpbC9zYW1wbGUtcG8tcG9wdXAtZW1haWwuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXBvcHVwLWVtYWlsL3NhbXBsZS1wby1wb3B1cC1lbWFpbC5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tcG9wdXAnLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tcG9wdXAuY29tcG9uZW50Lmh0bWwnLFxuICBwcm92aWRlcnM6IFtQb0NvbnRyb2xQb3NpdGlvblNlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIFBvUG9wdXBDb21wb25lbnQgZXh0ZW5kcyBQb1BvcHVwQmFzZUNvbXBvbmVudCB7XG4gIEBWaWV3Q2hpbGQoJ3BvcHVwUmVmJywgeyByZWFkOiBFbGVtZW50UmVmIH0pIHBvcHVwUmVmOiBFbGVtZW50UmVmO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHZpZXdDb250YWluZXJSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBwb0NvbnRyb2xQb3NpdGlvbjogUG9Db250cm9sUG9zaXRpb25TZXJ2aWNlLFxuICAgIHB1YmxpYyBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWZcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnBhcmVudFJlZiA9IGdldFBhcmVudFJlZih2aWV3Q29udGFpbmVyUmVmKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGZWNoYSBvIGNvbXBvbmVudGUgKnBvcHVwKi5cbiAgICpcbiAgICogPiBQb3IgcGFkcsOjbywgZXN0ZSBjb21wb3J0YW1lbnRvIMOpIGFjaW9uYWRvIHNvbWVudGUgYW8gY2xpY2FyIGZvcmEgZG8gY29tcG9uZW50ZSBvdSBlbSBkZXRlcm1pbmFkYSBhw6fDo28gLyB1cmwuXG4gICAqL1xuICBjbG9zZSgpIHtcbiAgICB0aGlzLnJlbW92ZUxpc3RlbmVycygpO1xuXG4gICAgdGhpcy5zaG93UG9wdXAgPSBmYWxzZTtcbiAgfVxuXG4gIG9uQWN0aW9uQ2xpY2socG9wdXBBY3Rpb246IFBvUG9wdXBBY3Rpb24pIHtcbiAgICBjb25zdCBhY3Rpb25Ob0Rpc2FibGVkID0gcG9wdXBBY3Rpb24gJiYgIXRoaXMucmV0dXJuQm9vbGVhblZhbHVlKHBvcHVwQWN0aW9uLCAnZGlzYWJsZWQnKTtcblxuICAgIGlmIChwb3B1cEFjdGlvbiAmJiBwb3B1cEFjdGlvbi5hY3Rpb24gJiYgYWN0aW9uTm9EaXNhYmxlZCkge1xuICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgcmV0dXJuIGNhbGxGdW5jdGlvbihwb3B1cEFjdGlvbi5hY3Rpb24sIHRoaXMucGFyZW50UmVmLCB0aGlzLnBhcmFtIHx8IHBvcHVwQWN0aW9uKTtcbiAgICB9XG5cbiAgICBpZiAocG9wdXBBY3Rpb24gJiYgcG9wdXBBY3Rpb24udXJsICYmIGFjdGlvbk5vRGlzYWJsZWQpIHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgIHJldHVybiB0aGlzLm9wZW5VcmwocG9wdXBBY3Rpb24udXJsKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWJyZSBvIGNvbXBvbmVudGUgKnBvcHVwKi5cbiAgICpcbiAgICogPiDDiSBwb3Nzw612ZWwgaW5mb3JtYXIgdW0gcGFyw6JtZXRybyBxdWUgc2Vyw6EgdXRpbGl6YWRvIG5hIGV4ZWN1w6fDo28gZGEgYcOnw6NvIGRvIGl0ZW0gZSBuYSBmdW7Dp8OjbyBkZSBkZXNhYmlsaXRhci5cbiAgICovXG4gIG9wZW4ocGFyYW0/KSB7XG4gICAgdGhpcy5vbGRUYXJnZXQgPSB0aGlzLnRhcmdldDtcbiAgICB0aGlzLnBhcmFtID0gcGFyYW07XG4gICAgdGhpcy5zaG93UG9wdXAgPSB0cnVlO1xuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIHRoaXMudmFsaWRhdGVJbml0aWFsQ29udGVudCgpO1xuICB9XG5cbiAgcmV0dXJuQm9vbGVhblZhbHVlKHBvcHVwQWN0aW9uOiBhbnksIHByb3BlcnR5OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gaXNUeXBlb2YocG9wdXBBY3Rpb25bcHJvcGVydHldLCAnZnVuY3Rpb24nKVxuICAgICAgPyBwb3B1cEFjdGlvbltwcm9wZXJ0eV0odGhpcy5wYXJhbSB8fCBwb3B1cEFjdGlvbilcbiAgICAgIDogcG9wdXBBY3Rpb25bcHJvcGVydHldO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc3BvbnPDoXZlbCBwb3IgYWJyaXIgZSBmZWNoYXIgbyAqcG9wdXAqLlxuICAgKlxuICAgKiBRdWFuZG8gZGlzcGFyYWRvIGFicmlyw6EgbyAqcG9wdXAqIGUgY2FzbyBvIG1lc21vIGrDoSBlc3RpdmVyIGFiZXJ0byBlIHBvc3N1aXIgbyBtZXNtbyBgdGFyZ2V0YCBpcsOhIGZlY2hhLWxvLlxuICAgKlxuICAgKiDDiSBwb3Nzw612ZWwgaW5mb3JtYXIgdW0gcGFyw6JtZXRybyBxdWUgc2Vyw6EgdXRpbGl6YWRvIG5hIGV4ZWN1w6fDo28gZGEgYcOnw6NvIGRvIGl0ZW0gZSBuYSBmdW7Dp8OjbyBkZSBkZXNhYmlsaXRhci5cbiAgICovXG4gIHRvZ2dsZShwYXJhbT8pIHtcbiAgICB0aGlzLnNob3dQb3B1cCAmJiB0aGlzLm9sZFRhcmdldCA9PT0gdGhpcy50YXJnZXQgPyB0aGlzLmNsb3NlKCkgOiB0aGlzLm9wZW4ocGFyYW0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGlja2VkT3V0RGlzYWJsZWRJdGVtKGV2ZW50KSB7XG4gICAgY29uc3QgY29udGFpbnNJdGVtRGlzYWJsZWQgPVxuICAgICAgdGhpcy5lbGVtZW50Q29udGFpbnMoZXZlbnQudGFyZ2V0LCAncG8tcG9wdXAtaXRlbS1kaXNhYmxlZCcpIHx8XG4gICAgICB0aGlzLmVsZW1lbnRDb250YWlucyhldmVudC50YXJnZXQucGFyZW50RWxlbWVudCwgJ3BvLXBvcHVwLWl0ZW0tZGlzYWJsZWQnKTtcblxuICAgIHJldHVybiAhY29udGFpbnNJdGVtRGlzYWJsZWQ7XG4gIH1cblxuICBwcml2YXRlIGNsaWNrZWRPdXRIZWFkZXJUZW1wbGF0ZShldmVudCkge1xuICAgIGNvbnN0IHBvcHVwSGVhZGVyVGVtcGxhdGUgPSB0aGlzLnBvcHVwUmVmICYmIHRoaXMucG9wdXBSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdbcC1wb3B1cC1oZWFkZXItdGVtcGxhdGVdJyk7XG4gICAgcmV0dXJuICEocG9wdXBIZWFkZXJUZW1wbGF0ZSAmJiBwb3B1cEhlYWRlclRlbXBsYXRlLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGlja2VkT3V0VGFyZ2V0KGV2ZW50KSB7XG4gICAgcmV0dXJuIHRoaXMudGFyZ2V0ICYmICF0aGlzLnRhcmdldC5jb250YWlucyhldmVudC50YXJnZXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBjbG9zZVBvcHVwT25DbGlja291dChldmVudDogTW91c2VFdmVudCkge1xuICAgIGlmICh0aGlzLmNsaWNrZWRPdXRUYXJnZXQoZXZlbnQpICYmIHRoaXMuY2xpY2tlZE91dERpc2FibGVkSXRlbShldmVudCkgJiYgdGhpcy5jbGlja2VkT3V0SGVhZGVyVGVtcGxhdGUoZXZlbnQpKSB7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBlbGVtZW50Q29udGFpbnMoZWxlbWVudDogSFRNTEVsZW1lbnQsIGNsYXNzTmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGVsZW1lbnQgJiYgZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoY2xhc3NOYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzQ29udGVudFRvU2hvdygpIHtcbiAgICByZXR1cm4gISEodGhpcy5wb3B1cFJlZi5uYXRpdmVFbGVtZW50ICYmIHRoaXMucG9wdXBSZWYubmF0aXZlRWxlbWVudC5jbGllbnRIZWlnaHQpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplTGlzdGVuZXJzKCkge1xuICAgIHRoaXMucmVzaXplTGlzdGVuZXIgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbignd2luZG93JywgJ3Jlc2l6ZScsICgpID0+IHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9KTtcblxuICAgIHRoaXMuY2xpY2tvdXRMaXN0ZW5lciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKCdkb2N1bWVudCcsICdjbGljaycsIChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgICAgdGhpcy5jbG9zZVBvcHVwT25DbGlja291dChldmVudCk7XG4gICAgfSk7XG5cbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5vblNjcm9sbCwgdHJ1ZSk7XG4gIH1cblxuICBwcml2YXRlIG9uU2Nyb2xsID0gKCk6IHZvaWQgPT4ge1xuICAgIGlmICh0aGlzLnNob3dQb3B1cCkge1xuICAgICAgdGhpcy5jbG9zZSgpO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIG9wZW5VcmwodXJsOiBzdHJpbmcpIHtcbiAgICBpZiAoaXNFeHRlcm5hbExpbmsodXJsKSkge1xuICAgICAgcmV0dXJuIG9wZW5FeHRlcm5hbExpbmsodXJsKTtcbiAgICB9XG5cbiAgICBpZiAodXJsKSB7XG4gICAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3VybF0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlTGlzdGVuZXJzKCkge1xuICAgIGlmICh0aGlzLmNsaWNrb3V0TGlzdGVuZXIpIHtcbiAgICAgIHRoaXMuY2xpY2tvdXRMaXN0ZW5lcigpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlc2l6ZUxpc3RlbmVyKSB7XG4gICAgICB0aGlzLnJlc2l6ZUxpc3RlbmVyKCk7XG4gICAgfVxuXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMub25TY3JvbGwsIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQb3NpdGlvbigpIHtcbiAgICB0aGlzLnBvQ29udHJvbFBvc2l0aW9uLnNldEVsZW1lbnRzKFxuICAgICAgdGhpcy5wb3B1cFJlZi5uYXRpdmVFbGVtZW50LFxuICAgICAgOCxcbiAgICAgIHRoaXMudGFyZ2V0LFxuICAgICAgdGhpcy5jdXN0b21Qb3NpdGlvbnMsXG4gICAgICBmYWxzZSxcbiAgICAgIHRoaXMuaXNDb3JuZXJBbGlnblxuICAgICk7XG4gICAgdGhpcy5wb0NvbnRyb2xQb3NpdGlvbi5hZGp1c3RQb3NpdGlvbih0aGlzLnBvc2l0aW9uKTtcbiAgICB0aGlzLmFycm93RGlyZWN0aW9uID0gdGhpcy5wb0NvbnRyb2xQb3NpdGlvbi5nZXRBcnJvd0RpcmVjdGlvbigpO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZUluaXRpYWxDb250ZW50KCkge1xuICAgIGlmICh0aGlzLmhhc0NvbnRlbnRUb1Nob3coKSkge1xuICAgICAgdGhpcy5zZXRQb3NpdGlvbigpO1xuICAgICAgdGhpcy5pbml0aWFsaXplTGlzdGVuZXJzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==